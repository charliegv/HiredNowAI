{% extends "layout.html" %}

{% block content %}

<div class="max-w-6xl mx-auto py-8 px-4">

  <!-- ALERT STACK -->
  <div class="space-y-4 mb-8">

    {% if session.admin_id %}
    <div class="rounded-xl border border-red-200 bg-red-50 p-4 flex flex-wrap items-center justify-between gap-4">
      <div class="text-sm text-red-700 font-medium">
        You are currently impersonating this user.
      </div>
      <a href="{{ url_for('admin.stop_impersonation') }}"
         class="inline-flex items-center gap-2 px-4 py-2 rounded-lg
                bg-red-600 text-white text-sm font-semibold
                hover:bg-red-700 transition shadow">
        Exit admin impersonation
      </a>
    </div>
    {% endif %}

    {% if not profile.is_active %}
    <div class="rounded-xl border border-red-200 bg-red-50 p-5 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <p class="text-sm font-semibold text-red-700">
          Your account is currently on hold
        </p>
        <p class="text-sm text-red-600 mt-1">
          {{ profile.deactivate_reason|replace("_"," ")|capitalize }}
        </p>
      </div>
      <a href="{{ url_for('contact.contact_page') }}"
         class="inline-flex items-center justify-center px-5 py-2 rounded-lg
                bg-red-600 text-white text-sm font-semibold
                hover:bg-red-700 transition shadow">
        Resolve
      </a>
    </div>
    {% endif %}

  </div>

  <!-- HEADER -->
  <div class="mb-8">
    <h1 class="text-3xl font-semibold text-gray-900 flex flex-wrap items-center gap-3">
      Welcome back, {{ current_user.profile.first_name or current_user.email }}



      <span class="px-3 py-1 text-xs rounded-full
        {% if profile.application_mode == 'auto' %}
          bg-green-100 text-green-700
        {% else %}
          bg-yellow-100 text-yellow-700
        {% endif %}">
        {{ profile.application_mode | capitalize }} mode
      </span>

      <span class="px-3 py-1 text-xs rounded-full bg-blue-100 text-blue-700">
        {{ profile.match_mode | capitalize }} matching
      </span>
    </h1>

    <p class="text-gray-600 mt-1">
      Here is what is happening with your job search.
    </p>
  </div>

  <!-- ACTION BAR -->
  <div class="flex flex-wrap gap-3 mb-8">
    <a href="{{ url_for('onboarding.cv_preview') }}"
       class="px-5 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition text-sm font-medium">
      View CV
    </a>

    <a href="{{ url_for('onboarding.edit_cv') }}"
       class="px-5 py-2 bg-white border border-gray-300 rounded-lg shadow-sm hover:bg-gray-100 transition text-sm font-medium">
      Edit CV
    </a>

    <a href="{{ url_for('preferences.preferences_page') }}"
       class="px-5 py-2 bg-white border border-gray-300 rounded-lg shadow-sm hover:bg-gray-100 transition text-sm font-medium">
      Preferences
    </a>
  </div>



  <!-- METRICS -->
  <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 mb-10">
    <div class="flex items-center justify-between cursor-pointer" onclick="toggleMetrics()">
      <h2 class="text-xl font-semibold text-gray-900">Metrics</h2>
      <span id="metricsToggleIcon" class="text-gray-500 text-xl">+</span>
    </div>

    <div id="metricsPanel" class="mt-6 hidden">
      <p class="text-gray-600 text-sm mb-4">
        Applications successfully submitted per day (last 60 days)
      </p>
      <div class="w-full h-64">
        <canvas id="metricsChart"></canvas>
      </div>
    </div>
  </div>
    <!-- STATS GRID -->
<!-- METRICS SUMMARY ROW -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">

  <!-- Applications sent -->
  <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
    <p class="text-gray-600 text-sm mb-1">Applications sent</p>
    <p class="text-3xl font-bold text-gray-900">
      {{ stats.applications_sent }}
    </p>
  </div>

  <!-- Matching jobs -->
  <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
    <p class="text-gray-600 text-sm mb-1">Matching jobs</p>
    <p class="text-3xl font-bold text-gray-900">
      {{ stats.match_count }}
    </p>
    <p class="text-sm text-gray-500 mt-1">
      Based on your preferences
    </p>
  </div>

  <!-- Credits remaining -->
  <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
    <p class="text-gray-600 text-sm mb-1">Credits remaining</p>
    <p class="text-3xl font-bold {% if available_credits > 0 %}text-gray-900{% else %}text-red-600{% endif %}">
      {{ available_credits }}
    </p>

    {% if available_credits > 0 %}
      <p class="text-sm text-green-600 mt-1">Ready to apply</p>
    {% else %}
      <p class="text-sm text-red-600 mt-1">Automation paused</p>
    {% endif %}
  </div>

<!-- Subscription -->
<div class="p-6 rounded-xl border-2
     {% if not subscription %}
       border-blue-500 bg-blue-50 shadow-md
     {% else %}
       border-gray-100 bg-white shadow-sm
     {% endif %}
">

  <p class="text-sm font-semibold mb-1
     {% if not subscription %}
       text-blue-700
     {% else %}
       text-gray-600
     {% endif %}
  ">
    Subscription
  </p>

  {% if subscription %}
    <p class="text-lg font-semibold text-gray-900 capitalize">
      {{ subscription.plan.name }}
    </p>

    <p class="text-sm text-gray-600 mt-1">
      Renews {{ subscription.current_period_end.strftime("%d %b %Y") }}
    </p>

    <a href="{{ url_for('billing.billing_portal') }}"
       class="inline-block mt-3 text-blue-600 hover:text-blue-700 text-sm font-semibold">
      Manage
    </a>

  {% else %}
    <!-- FREE TRIAL STATE -->
    <div class="flex items-center gap-2 mt-1">
<span class="inline-flex items-center gap-1
             px-3 py-1 rounded-full
             text-xs font-semibold
             bg-orange-100 text-orange-700
             whitespace-nowrap">
  Free
</span>

      </span>
      <span class="text-xs text-blue-700 font-medium">
        Manual Credit Purchases Required
      </span>
    </div>

    <p class="text-sm text-blue-800 mt-2 leading-snug">
      Upgrade to keep applications running.
    </p>

    <a href="{{ url_for('billing.buy_credits_page') }}"
       class="inline-flex items-center justify-center mt-4
              w-full px-4 py-2 rounded-full
              bg-blue-600 text-white
              text-sm font-semibold
              hover:bg-blue-700 transition shadow">
      Add credits
    </a>
  {% endif %}

</div>


</div>


  <!-- APPLICATION ACTIVITY SECTION -->
  <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100 mb-10">

    <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
      <h2 class="text-xl font-semibold text-gray-900">
        Application activity
      </h2>
      <a href="{{ url_for('preferences.preferences_page') }}"
         class="text-primary hover:underline text-sm">
        Adjust preferences
      </a>
    </div>

    {% if activity and activity|length > 0 %}

      <!-- DESKTOP TABLE -->
      <div class="max-h-96 overflow-y-auto border-t border-gray-200 hidden md:block">
        <div class="overflow-x-auto">
          <table id="activityTable" class="w-full text-left text-sm min-w-[720px]">

            <thead class="bg-gray-50">
              <tr class="text-gray-600 border-b">

                <th class="py-3 px-2 cursor-pointer select-none"
                    data-sort-key="job_title" data-sort-type="text">
                  <div class="flex items-center gap-1">
                    <span>Job title</span>
                    <span class="text-xs opacity-60 sort-icon">↕</span>
                  </div>
                </th>

                <th class="py-3 px-2 cursor-pointer select-none"
                    data-sort-key="company" data-sort-type="text">
                  <div class="flex items-center gap-1">
                    <span>Company</span>
                    <span class="text-xs opacity-60 sort-icon">↕</span>
                  </div>
                </th>

                <th class="py-3 px-2 cursor-pointer select-none"
                    data-sort-key="status" data-sort-type="text">
                  <div class="flex items-center gap-1">
                    <span>Status</span>
                    <span class="text-xs opacity-60 sort-icon">↕</span>
                  </div>
                </th>

                <th class="py-3 px-2 cursor-pointer select-none"
                    data-sort-key="date" data-sort-type="num">
                  <div class="flex items-center gap-1">
                    <span>Date</span>
                    <span class="text-xs opacity-60 sort-icon">↕</span>
                  </div>
                </th>

                <th class="py-3 px-2 text-right">
                  Actions
                </th>

              </tr>
            </thead>

            <tbody id="activityBody">
              {% for app in activity %}
              <tr class="border-b hover:bg-gray-50 transition">

                <!-- Job title -->
                <td class="py-3 px-2 font-medium text-gray-900"
                    data-col="job_title"
                    data-sort-value="{{ app.job_title|lower }}">
                  <a href="{{ app.job_url }}" target="_blank" rel="noopener noreferrer"
                     class="inline-flex items-center gap-1 group">
                    <span class="text-gray-900">
                      {{ app.job_title }}
                    </span>
                    <span class="inline-block w-4 h-4 border border-gray-300 rounded-sm
                                 flex items-center justify-center text-[10px]
                                 group-hover:border-gray-400 transition">
                      ↗
                    </span>
                  </a>
                </td>

                <!-- Company -->
                <td class="py-3 px-2 text-gray-700"
                    data-col="company"
                    data-sort-value="{{ app.company|lower }}">
                  {{ app.company }}
                </td>

                <!-- Status -->
<td class="py-3 px-2"
    data-col="status"
    data-sort-value="{{ app.status|lower }}">

  {% if app.status in ["success", "manual_success"] %}
    <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">
      Successful
    </span>

  {% elif app.status == "pending" and available_credits == 0 %}
    <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-700 whitespace-nowrap">
      Waiting for credits
    </span>

  {% elif app.status == "pending" %}
    <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-700">
      Pending
    </span>

  {% elif app.status == "processing" %}
    <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-700">
      Processing
    </span>

  {% elif app.status == "failed" %}
    <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-700">
      Failed
    </span>

  {% elif app.status == "cancelled" %}
    <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">
      Cancelled
    </span>
  {% endif %}

</td>


                <!-- Date -->
                <td class="py-3 px-2 text-gray-600 text-sm"
                    data-col="date"
                    data-sort-value="{{ app.created_at.timestamp() }}">
                  {{ app.created_at.strftime('%d %b %Y') }}
                </td>

                <!-- Actions -->
                <td class="py-3 px-2 text-right align-top">

                  {% if app.status == "success" %}

                    <a href="{{ url_for('dashboard.view_cv_variant', app_id=app.id) }}"
                       class="text-blue-600 hover:text-blue-700 text-xs md:text-sm mr-3">
                      View CV variant
                    </a>

                    <a href="{{ url_for('dashboard.view_application_screenshot', app_id=app.id) }}"
                       class="text-blue-600 hover:text-blue-700 text-xs md:text-sm">
                      View screenshot
                    </a>

{% elif app.status == "pending" %}

  {% if available_credits == 0 %}
    <div class="flex justify-end gap-4">

      <form method="POST"
            action="{{ url_for('dashboard.cancel_application', app_id=app.id) }}">
        <button class="text-gray-500 hover:text-gray-700 text-xs md:text-sm">
          Cancel
        </button>
      </form>

      <a href="{{ url_for('billing.buy_credits_page') }}"
         class="text-blue-600 hover:text-blue-700 text-xs md:text-sm font-semibold">
        Add Credits
      </a>

    </div>

  {% else %}
    <form method="POST"
          class="inline"
          action="{{ url_for('dashboard.cancel_application', app_id=app.id) }}">
      <button class="text-red-600 hover:text-red-700 text-xs md:text-sm">
        Cancel
      </button>
    </form>
  {% endif %}


                  {% elif app.status == "failed" %}

                    <form method="POST"
                          class="inline"
                          action="{{ url_for('dashboard.retry_application', app_id=app.id) }}">
                      <button class="text-yellow-600 hover:text-yellow-700 text-xs md:text-sm mr-3">
                        Request retry
                      </button>
                    </form>

                    <form method="POST"
                          class="inline"
                          action="{{ url_for('dashboard.report_application_issue', app_id=app.id) }}">
                      <button class="text-red-600 hover:text-red-700 text-xs md:text-sm mr-3">
                        Report
                      </button>
                    </form>

                    <a href="{{ url_for('dashboard.view_error', app_id=app.id) }}"
                       class="text-gray-600 hover:text-gray-700 text-xs md:text-sm">
                      View error
                    </a>

                  {% elif app.status == "processing" %}
                    <span class="text-gray-500 text-xs md:text-sm">
                      Processing in background
                    </span>
                  {% endif %}

                </td>

              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- MOBILE CARD LIST -->
      <div class="border-t border-gray-200 mt-4 space-y-4 md:hidden max-h-96 overflow-y-auto pt-4">
        {% for app in activity %}
        <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-4 flex flex-col gap-3">

          <!-- Top row: title and status -->
          <div class="flex items-start justify-between gap-3">
            <div>
              <a href="{{ app.job_url }}" target="_blank" rel="noopener noreferrer"
                 class="inline-flex items-center gap-1 group">
                <span class="font-semibold text-gray-900">
                  {{ app.job_title }}
                </span>
                <span class="inline-block w-4 h-4 border border-gray-300 rounded-sm
                             flex items-center justify-center text-[10px]
                             group-hover:border-gray-400 transition">
                  ↗
                </span>
              </a>
              <div class="text-xs text-gray-500 mt-1">
                {{ app.company }} · {{ app.created_at.strftime('%d %b %Y') }}
              </div>
            </div>

            <div>
              {% if app.status == "success" or app.status == "manual_success" %}
                <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">
                  Successful
                </span>
{% elif app.status == "pending" and available_credits == 0 %}
  <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-700 whitespace-nowrap">
    Waiting for credits
  </span>

{% elif app.status == "pending" %}
  <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-700">
    Pending
  </span>

              {% elif app.status == "processing" %}
                <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-700">
                  Processing
                </span>
              {% elif app.status == "failed" %}
                <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-700">
                  Failed
                </span>
              {% elif app.status == "cancelled" %}
                <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">
                  Cancelled
                </span>
              {% endif %}
            </div>
          </div>

          <!-- Actions row -->
          <div class="pt-2 border-t border-gray-100 flex flex-wrap gap-3 justify-end">

            {% if app.status == "success" %}

              <a href="{{ url_for('dashboard.view_cv_variant', app_id=app.id) }}"
                 class="text-blue-600 hover:text-blue-700 text-xs font-medium">
                View CV variant
              </a>

              <a href="{{ url_for('dashboard.view_application_screenshot', app_id=app.id) }}"
                 class="text-blue-600 hover:text-blue-700 text-xs font-medium">
                View screenshot
              </a>

{% elif app.status == "pending" %}

  {% if available_credits == 0 %}
    <div class="flex gap-4 justify-end">

      <form method="POST"
            action="{{ url_for('dashboard.cancel_application', app_id=app.id) }}">
        <button class="text-gray-500 hover:text-gray-700 text-xs font-medium">
          Cancel
        </button>
      </form>

      <a href="{{ url_for('billing.buy_credits_page') }}"
         class="text-blue-600 hover:text-blue-700 text-xs font-semibold">
        Add Credits
      </a>

    </div>

  {% else %}
    <form method="POST"
          action="{{ url_for('dashboard.cancel_application', app_id=app.id) }}">
      <button class="text-red-600 hover:text-red-700 text-xs font-medium">
        Cancel
      </button>
    </form>
  {% endif %}


            {% elif app.status == "failed" %}

              <form method="POST"
                    class="inline"
                    action="{{ url_for('dashboard.retry_application', app_id=app.id) }}">
                <button class="text-yellow-600 hover:text-yellow-700 text-xs font-medium">
                  Request retry
                </button>
              </form>

              <form method="POST"
                    class="inline"
                    action="{{ url_for('dashboard.report_application_issue', app_id=app.id) }}">
                <button class="text-red-600 hover:text-red-700 text-xs font-medium">
                  Report
                </button>
              </form>

              <a href="{{ url_for('dashboard.view_error', app_id=app.id) }}"
                 class="text-gray-600 hover:text-gray-700 text-xs font-medium">
                View error
              </a>

            {% elif app.status == "processing" %}
              <span class="text-gray-500 text-xs">
                Processing in background
              </span>
            {% endif %}

          </div>

        </div>
        {% endfor %}
      </div>

    {% else %}
      <p class="text-gray-600">
        No application activity has been recorded yet. As soon as your automation applies to roles, they will appear here.
      </p>
    {% endif %}

  </div>

  <!-- MANUAL ACTIONS REQUIRED -->
  {% if manual_required and manual_required|length > 0 %}
  <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100 mb-10">

    <h2 class="text-xl font-semibold mb-4 text-gray-900">
      Manual actions required
    </h2>

    <div class="space-y-4">
      {% for app in manual_required %}
      <div class="p-4 border rounded-xl bg-yellow-50 flex flex-col md:flex-row md:items-center md:justify-between gap-4">

        <div>
          <div class="font-medium text-gray-800">
            {{ app.job_title }}
          </div>
          <div class="text-sm text-gray-600">
            {{ app.company }}
          </div>

          {% if app.error_message %}
          <div class="text-xs text-gray-500 mt-1">
            {{ app.error_message }}
          </div>
          {% endif %}
        </div>

        <div class="flex items-center gap-4" id="manual-box-{{ app.id }}">

          {% if app.cv_variant_url %}
          <a href="{{ url_for('dashboard.view_cv_variant', app_id=app.id) }}"
             class="text-blue-600 underline text-xs md:text-sm">
            Download CV
          </a>
          {% endif %}

          <button
            class="bg-red-600 text-white px-4 py-2 rounded-md text-xs md:text-sm font-medium hover:bg-red-700"
            onclick="startManualApply({{ app.id }}, '{{ app.job_url }}')"
            id="start-btn-{{ app.id }}">
            Apply manually now
          </button>

          {% if app.manual_started %}
          <button
            class="bg-green-600 text-white px-4 py-2 rounded-md text-xs md:text-sm font-medium hover:bg-green-700"
            onclick="completeManualApply({{ app.id }})"
            id="complete-btn-{{ app.id }}">
            Mark application completed
          </button>
          {% endif %}

        </div>

      </div>
      {% endfor %}
    </div>

  </div>
  {% endif %}

  <!-- TOP MATCHES SECTION -->
  <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100 mb-10">

    <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
      <h2 class="text-xl font-semibold text-gray-900">
        Top matches for you
      </h2>
      <a href="{{ url_for('preferences.preferences_page') }}"
         class="text-primary hover:underline text-sm">
        Improve matching
      </a>
    </div>

    {% if matches and matches|length > 0 %}

      <!-- DESKTOP TABLE -->
      <div class="max-h-96 overflow-y-auto border-t border-gray-200 hidden md:block">
        <div class="overflow-x-auto">
          <table id="matchesTable" class="w-full text-left text-sm min-w-[720px]">

            <thead class="bg-gray-50">
              <tr class="text-gray-600 border-b">

                <th class="py-3 px-2 cursor-pointer select-none"
                    data-sort-key="job_title" data-sort-type="text">
                  <div class="flex items-center gap-1">
                    <span>Job title</span>
                    <span class="text-xs opacity-60 sort-icon">↕</span>
                  </div>
                </th>

                <th class="py-3 px-2 cursor-pointer select-none"
                    data-sort-key="company" data-sort-type="text">
                  <div class="flex items-center gap-1">
                    <span>Company</span>
                    <span class="text-xs opacity-60 sort-icon">↕</span>
                  </div>
                </th>

                <th class="py-3 px-2 cursor-pointer select-none"
                    data-sort-key="remote" data-sort-type="text">
                  <div class="flex items-center gap-1">
                    <span>Location</span>
                    <span class="text-xs opacity-60 sort-icon">↕</span>
                  </div>
                </th>

                <th class="py-3 px-2 cursor-pointer select-none"
                    data-sort-key="score" data-sort-type="num">
                  <div class="flex items-center gap-1">
                    <span>Score</span>
                    <span class="text-xs opacity-60 sort-icon">↕</span>
                  </div>
                </th>

                <th class="py-3 px-2 text-right">
                  Actions
                </th>

              </tr>
            </thead>

            <tbody id="matchesBody">
              {% for m, job_title, company, city, state, country, remote in matches %}
              <tr class="border-b hover:bg-gray-50 transition">

                <!-- Job title -->
                <td class="py-3 px-2 font-medium text-gray-900"
                    data-col="job_title"
                    data-sort-value="{{ (job_title or 'Unknown title')|lower }}">
                  <a href="{{ m.job_url }}" target="_blank"
                     class="group inline-flex items-center gap-1">
                    {{ job_title or "Unknown title" }}
                    <span class="inline-block w-4 h-4 border border-gray-300 rounded-sm
                                 flex items-center justify-center text-[10px]
                                 group-hover:border-gray-400 transition">
                      ↗
                    </span>
                  </a>
                </td>

                <!-- Company -->
                <td class="py-3 px-2 text-gray-700"
                    data-col="company"
                    data-sort-value="{{ (company or 'Unknown company')|lower }}">
                  {{ company or "Unknown company" }}
                </td>

                <!-- Location or remote -->
                <td class="py-3 px-2 text-gray-600 text-sm"
                    data-col="remote"
                    data-sort-value="{% if remote %}remote{% else %}local{% endif %}">
                  {% if remote %}
                    <span class="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded-full">
                      Remote
                    </span>
                  {% else %}
                    {{ city }}, {{ state }}
                  {% endif %}
                </td>

                <!-- Score -->
                <td class="py-3 px-2 font-semibold text-gray-800"
                    data-col="score"
                    data-sort-value="{{ m.score or 0 }}">
                  {{ "%.2f"|format(m.score) }}
                </td>

                <!-- Apply -->
                <td class="py-3 px-2 text-right">
                  <form method="POST"
                        action="{{ url_for('dashboard.apply_from_match', match_id=m.id) }}">
                    <button class="text-blue-600 hover:text-blue-700 text-xs md:text-sm">
                      Apply
                    </button>
                  </form>
                </td>

              </tr>
              {% endfor %}
            </tbody>

          </table>
        </div>
      </div>

      <!-- MOBILE CARD LIST -->
      <div class="border-t border-gray-200 mt-4 space-y-4 md:hidden max-h-96 overflow-y-auto pt-4">
        {% for m, job_title, company, city, state, country, remote in matches %}
        <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-4 flex flex-col gap-3">

          <div class="flex items-start justify-between gap-3">
            <div>
              <a href="{{ m.job_url }}" target="_blank"
                 class="group inline-flex items-center gap-1">
                <span class="font-semibold text-gray-900">
                  {{ job_title or "Unknown title" }}
                </span>
                <span class="inline-block w-4 h-4 border border-gray-300 rounded-sm
                             flex items-center justify-center text-[10px]
                             group-hover:border-gray-400 transition">
                  ↗
                </span>
              </a>
              <div class="text-xs text-gray-500 mt-1">
                {{ company or "Unknown company" }}
                {% if not remote and city %}
                  · {{ city }}{% if state %}, {{ state }}{% endif %}
                {% endif %}
              </div>
            </div>

            <div class="text-right">
              {% if remote %}
                <span class="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded-full">
                  Remote
                </span>
              {% else %}
                <span class="px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded-full">
                  Local
                </span>
              {% endif %}
              <div class="text-xs text-gray-500 mt-1">
                Score {{ "%.2f"|format(m.score) }}
              </div>
            </div>
          </div>

          <div class="pt-2 border-t border-gray-100 flex justify-end">
            <form method="POST"
                  action="{{ url_for('dashboard.apply_from_match', match_id=m.id) }}">
              <button class="text-blue-600 hover:text-blue-700 text-xs font-medium">
                Apply
              </button>
            </form>
          </div>

        </div>
        {% endfor %}
      </div>

    {% else %}
      <p class="text-gray-600">
        No matches found yet. Adjust your preferences to improve matching.
      </p>
    {% endif %}

  </div>

  <!-- AUTOMATION STATUS -->
  <!-- APPLICATION AUTOMATION -->
<div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100">

  <div class="flex items-center justify-between mb-6">
    <h2 class="text-xl font-semibold text-gray-900">Application automation</h2>

    <!-- Running indicator -->
    <div class="flex items-center gap-2">
      <span class="h-3 w-3 rounded-full
        {% if automation_running %} bg-green-500 {% else %} bg-red-500 {% endif %}">
      </span>
      <span class="text-sm text-gray-700">
        {% if profile.is_active %}
          Active
        {% else %}
          Paused
        {% endif %}
      </span>
    </div>
  </div>

  <!-- QUICK SUMMARY ROW -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">

    <!-- Application Mode -->
    <div class="p-4 rounded-xl bg-gray-50 border border-gray-100">
      <p class="text-gray-500 text-xs mb-1">Application Mode</p>
      <p class="font-semibold text-gray-900 capitalize">{{ profile.application_mode }}</p>
    </div>


    <!-- Matching Mode -->
    <div class="p-4 rounded-xl bg-gray-50 border border-gray-100">
      <p class="text-gray-500 text-xs mb-1">Match Strictness</p>
      <p class="font-semibold text-gray-900 capitalize">{{ profile.match_mode }}</p>
    </div>

  </div>


  <!-- LOCATION & REMOTE PREFERENCES -->
  <h3 class="text-lg font-semibold text-gray-900 mb-3">Your job search radius</h3>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">

    <!-- Remote type -->
    <div class="p-4 rounded-xl bg-gray-50 border border-gray-100">
      <p class="text-gray-500 text-xs mb-1">Remote Preference</p>

      {% if not profile.remote_preference %}
        <p class="font-semibold text-gray-900">No remote (local only)</p>

      {% elif profile.remote_preference and not profile.worldwide_remote %}
        <p class="font-semibold text-gray-900">Remote – Nationwide only</p>

      {% elif profile.worldwide_remote %}
        <p class="font-semibold text-gray-900">Remote – Worldwide</p>
      {% endif %}
    </div>

    <!-- Distance radius -->
    <div class="p-4 rounded-xl bg-gray-50 border border-gray-100">
      <p class="text-gray-500 text-xs mb-1">Local Search Radius</p>
      <p class="font-semibold text-gray-900">
                  {% if profile.miles_distance == 5000  %}
          Nationwide
          {% elif profile.miles_distance %}
          {{ profile.miles_distance }} miles

        {% else %}
          Not set
        {% endif %}
      </p>
    </div>

    <!-- User location -->
    <div class="p-4 rounded-xl bg-gray-50 border border-gray-100">
      <p class="text-gray-500 text-xs mb-1">Your Location</p>
      <p class="font-semibold text-gray-900">
        {{ profile.city }},
        {% if profile.state %}{{ profile.state }},{% endif %}
        {{ profile.country }}
      </p>
    </div>

  </div>

  <!-- CTA -->
  <a href="{{ url_for('preferences.preferences_page') }}"
     class="inline-block bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-full shadow font-medium transition">
    Adjust settings
  </a>
</div>


</div>

<!-- SORTING AND MANUAL APPLY SCRIPTS -->
<script>
function initSortableTable(tableId) {
  const table = document.getElementById(tableId);
  if (!table) return;

  const body = table.querySelector("tbody");
  const headers = table.querySelectorAll("th[data-sort-key]");
  if (!body || headers.length === 0) return;

  const state = { key: null, direction: 1 };

  headers.forEach(th => {
    th.addEventListener("click", () => {
      const key = th.dataset.sortKey;
      const type = th.dataset.sortType || "text";

      if (state.key === key) {
        state.direction = state.direction * -1;
      } else {
        state.key = key;
        state.direction = 1;
      }

      headers.forEach(h => h.classList.remove("text-blue-600", "font-semibold"));
      th.classList.add("text-blue-600", "font-semibold");

      const rows = Array.from(body.querySelectorAll("tr"));

      rows.sort((a, b) => {
        const aCell = a.querySelector(`td[data-col="${key}"]`);
        const bCell = b.querySelector(`td[data-col="${key}"]`);

        if (!aCell || !bCell) return 0;

        const aRaw = aCell.dataset.sortValue ?? aCell.textContent.trim();
        const bRaw = bCell.dataset.sortValue ?? bCell.textContent.trim();

        if (type === "num") {
          const aNum = parseFloat(aRaw) || 0;
          const bNum = parseFloat(bRaw) || 0;
          return (aNum - bNum) * state.direction;
        }

        return String(aRaw).localeCompare(String(bRaw)) * state.direction;
      });

      rows.forEach(r => body.appendChild(r));
    });
  });
}

document.addEventListener("DOMContentLoaded", () => {
  initSortableTable("activityTable");
  initSortableTable("matchesTable");
});

async function startManualApply(appId, jobUrl) {
  window.open(jobUrl, "_blank");

  const res = await fetch(`/application/${appId}/manual-start`, {
    method: "POST",
    headers: { "X-Requested-With": "XMLHttpRequest" }
  });

  const data = await res.json();
  if (!data.success) {
    alert("Could not mark manual application as started.");
    return;
  }

  const box = document.getElementById(`manual-box-${appId}`);
  if (!box) return;

  if (!document.getElementById(`complete-btn-${appId}`)) {
    const btn = document.createElement("button");
    btn.id = `complete-btn-${appId}`;
    btn.className = "bg-green-600 text-white px-4 py-2 rounded-md text-xs md:text-sm font-medium hover:bg-green-700";
    btn.innerText = "Mark application completed";
    btn.onclick = () => completeManualApply(appId);
    box.appendChild(btn);
  }
}

async function completeManualApply(appId) {
  if (!confirm("Confirm that you have manually completed this application.")) return;

  const res = await fetch(`/application/${appId}/manual-complete`, {
    method: "POST",
    headers: { "X-Requested-With": "XMLHttpRequest" }
  });

  const data = await res.json();
  if (!data.success) {
    alert("Could not mark as completed.");
    return;
  }

  const btn = document.getElementById(`complete-btn-${appId}`);
  if (btn) {
    btn.innerText = "Completed ✓";
    btn.disabled = true;
    btn.classList.add("opacity-70", "cursor-not-allowed");
  }

  alert("Application marked as manually completed.");
}
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
function toggleMetrics() {
  const panel = document.getElementById("metricsPanel");
  const icon = document.getElementById("metricsToggleIcon");

  panel.classList.toggle("hidden");
  icon.textContent = panel.classList.contains("hidden") ? "+" : "-";

  // Render only after panel becomes visible
  if (!window.metricsLoaded && !panel.classList.contains("hidden")) {
      setTimeout(() => {
          loadMetrics();
          window.metricsLoaded = true;
      }, 80); // small delay fixes zero-size canvas issue
  }
}

async function loadMetrics() {
  const res = await fetch("/dashboard/metrics");
  const data = await res.json();

  const ctx = document.getElementById("metricsChart").getContext("2d");

  new Chart(ctx, {
    type: "line",
    data: {
      labels: data.labels,
      datasets: [{
        label: "Successful Applications",
        data: data.values,
        borderColor: "#f97316",
        backgroundColor: "rgba(249, 115, 22, 0.15)",
        borderWidth: 2,
        tension: 0.3,
        pointRadius: 3,
        pointBackgroundColor: "#f97316"
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { beginAtZero: true },
        x: { grid: { display: false } }
      }
    }
  });
}
</script>


{% endblock %}
